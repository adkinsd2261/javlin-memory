<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jav Studio - Memory-Driven Creative Workspace</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .memory-glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .creative-flow {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #06b6d4);
            background-size: 300% 300%;
            animation: gradient-flow 4s ease infinite;
        }

        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .memory-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .memory-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .chat-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }

        .typing-indicator {
            display: inline-block;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div x-data="javStudio()" x-init="init()" class="min-h-screen text-white">
        <!-- Header: Living Memory Status -->
        <header class="glass-panel border-b border-white/20 p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-8 h-8 rounded-full creative-flow flex items-center justify-center text-white font-bold">
                        J
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Jav Studio</h1>
                        <p class="text-sm text-gray-300">Memory-Driven Creative Workspace</p>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- Memory Status -->
                    <div class="flex items-center space-x-2 text-sm">
                        <div class="w-2 h-2 rounded-full" 
                             :class="{ 'bg-red-500': hasErrors, 'bg-yellow-500': hasWarnings, 'bg-green-500': !hasErrors && !hasWarnings }">
                        </div>
                        <span x-text="systemHealth"></span>
                    </div>

                    <!-- Memory Count -->
                    <div class="glass-panel px-3 py-1 rounded-full text-sm">
                        <span x-text="'🧠 ' + totalMemories + ' memories'"></span>
                    </div>
                </div>
            </div>

            <!-- Creative Insight Bar -->
            <div x-show="codeInsight" 
                 x-transition:enter="transition ease-out duration-150"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 class="mt-3 glass-panel rounded-lg p-3 memory-glow">
                <div class="flex items-center space-x-3">
                    <div class="text-blue-400">💡</div>
                    <div>
                        <div class="font-medium" x-text="codeInsight?.title"></div>
                        <div class="text-sm text-gray-300" x-text="codeInsight?.message"></div>
                    </div>
                    <button @click="codeInsight = null" class="text-gray-400 hover:text-white">
                        ✕
                    </button>
                </div>
            </div>
        </header>

        <div class="flex h-screen">
            <!-- Sidebar: Memory Brain -->
            <aside class="w-80 glass-panel border-r border-white/20 flex flex-col">
                <div class="p-4 border-b border-white/20">
                    <h2 class="font-bold text-lg mb-2">🧠 Living Project Brain</h2>
                    <div class="text-sm text-gray-300" x-text="studioStatus"></div>
                </div>

                <!-- Memory Timeline -->
                <div class="flex-1 overflow-y-auto p-4 space-y-3">
                    <template x-for="item in studioItems" :key="item.id">
                        <div class="memory-card glass-panel rounded-lg p-3"
                             @click="focusMemory(item)">
                            <div class="flex items-start space-x-3">
                                <div class="text-xl" x-text="item.icon"></div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-sm" x-text="item.title"></div>
                                    <div class="text-xs text-gray-400 truncate" x-text="item.preview"></div>
                                    <div class="text-xs text-blue-400 mt-1" x-text="item.timeAgo"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </aside>

            <!-- Main Workspace -->
            <main class="flex-1 flex flex-col">
                <!-- Conversation Canvas -->
                <div class="flex-1 p-6 overflow-y-auto" x-ref="conversationContainer">
                    <template x-for="message in conversationHistory" :key="message.id">
                        <div class="mb-6"
                             :class="message.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                            <div class="chat-bubble rounded-2xl p-4"
                                 :class="message.role === 'user' ? 'bg-blue-600 text-white' : 'glass-panel text-gray-100'">

                                <div class="flex items-start space-x-3">
                                    <div class="text-lg" x-text="message.role === 'user' ? '🧑‍💻' : '🤖'"></div>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium mb-1" x-text="message.role === 'user' ? 'You' : 'Jav'"></div>
                                        <div x-html="message.content"></div>
                                        <div class="text-xs opacity-70 mt-2" x-text="message.timestamp"></div>
                                    </div>
                                </div>

                                <!-- Implementation Cards -->
                                <div x-show="message.implementations && message.implementations.length > 0" class="mt-4 space-y-2">
                                    <template x-for="impl in message.implementations" :key="impl.id">
                                        <div class="bg-black/20 rounded-lg p-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-sm font-medium" x-text="impl.title"></span>
                                                <button @click="implementCode(impl)" 
                                                        class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">
                                                    Implement
                                                </button>
                                            </div>
                                            <div class="text-xs text-gray-300" x-text="impl.description"></div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Typing Indicator -->
                    <div x-show="javTyping" class="flex justify-start mb-6">
                        <div class="glass-panel rounded-2xl p-4 chat-bubble">
                            <div class="flex items-center space-x-3">
                                <div class="text-lg">🤖</div>
                                <div class="typing-indicator">Jav is thinking...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Creative Input Zone -->
                <div class="border-t border-white/20 p-6">
                    <!-- Drop Zone for Ideas -->
                    <div class="mb-4 border-2 border-dashed border-white/30 rounded-lg p-6 text-center transition-all"
                         :class="{ 'active': dragActive }"
                         @dragover.prevent="dragActive = true"
                         @dragleave="dragActive = false"
                         @drop.prevent="handleDrop($event)">

                        <div x-show="!dragActive" class="text-gray-400">
                            <div class="text-2xl mb-2">💭</div>
                            <div>Drop ideas, code snippets, or files to discuss with Jav</div>
                        </div>

                        <div x-show="dragActive" class="text-blue-400">
                            <div class="text-2xl mb-2">✨</div>
                            <div>Ready to capture your creative spark!</div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div x-show="studioItems.length === 0 && conversationHistory.length === 0" 
                         class="text-center py-12 text-gray-400">
                        <div class="text-4xl mb-4">🌟</div>
                        <h3 class="text-xl font-medium mb-2">Your Creative Journey Starts Here</h3>
                        <p class="mb-6">Every conversation becomes memory. Every memory fuels creativity.</p>
                        <button @click="startCreativeSession()" 
                                class="px-6 py-3 creative-flow rounded-lg text-white font-medium">
                            Begin Building
                        </button>
                    </div>

                    <!-- Implementation Panel -->
                    <div x-show="activeImplementation" 
                         class="mb-4 glass-panel rounded-lg p-4 memory-glow">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-medium">Ready to Implement</h3>
                            <button @click="activeImplementation = null" class="text-gray-400 hover:text-white">
                                ✕
                            </button>
                        </div>

                        <div class="text-sm text-gray-300 mb-3" x-text="activeImplementation?.description"></div>

                        <div x-show="activeImplementation?.code" class="bg-black/30 rounded p-3 mb-3">
                            <pre class="text-xs text-green-400" x-text="activeImplementation?.code"></pre>
                        </div>

                        <div class="flex space-x-2">
                            <button @click="applyImplementation()" 
                                    class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-sm">
                                Apply Changes
                            </button>
                            <button @click="previewImplementation()" 
                                    class="px-4 py-2 glass-panel hover:bg-white/10 rounded text-sm">
                                Preview Diff
                            </button>
                            <button @click="editImplementation()" 
                                    class="px-4 py-2 glass-panel hover:bg-white/10 rounded text-sm">
                                Edit First
                            </button>
                        </div>
                    </div>

                    <!-- Implementation History -->
                    <div x-show="implementationHistory.length > 0" class="mb-4">
                        <div class="text-sm text-gray-400 mb-2">Recent Implementations</div>
                        <div class="flex space-x-2 overflow-x-auto">
                            <template x-for="impl in implementationHistory.slice(0, 3)" :key="impl.id">
                                <div class="glass-panel rounded p-2 text-xs whitespace-nowrap cursor-pointer"
                                     @click="reviewImplementation(impl)">
                                    <span x-text="impl.title"></span>
                                    <span class="text-green-400 ml-2">✓</span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="flex space-x-3">
                        <div class="flex-1">
                            <textarea x-model="chatMessage" 
                                      :disabled="javTyping"
                                      @keydown.enter.prevent="handleEnter($event)"
                                      @input="handleInput()"
                                      placeholder="Share your ideas, ask questions, or describe what you want to build..."
                                      class="w-full p-4 glass-panel rounded-lg resize-none text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      rows="3"></textarea>
                        </div>

                        <div class="flex flex-col space-y-2">
                            <button @click="sendMessage()" 
                                    :disabled="!chatMessage.trim() || javTyping"
                                    class="px-6 py-4 creative-flow rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                <span x-show="!javTyping">Send</span>
                                <span x-show="javTyping" class="typing-indicator">...</span>
                            </button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                        <div>Press Ctrl+Enter to send • Drop files to analyze</div>
                        <div x-text="chatMessage.length + '/500'"></div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Floating Memory Helper -->
        <div x-show="dragging" 
             :style="`left: ${dragX}px; top: ${dragY}px;`"
             class="fixed pointer-events-none z-50 glass-panel rounded-lg p-3 memory-glow">
            <div class="flex items-center space-x-2">
                <div class="text-lg" :class="draggedItem?.type" x-text="draggedItem?.type"></div>
                <div class="text-sm" x-text="draggedItem?.content?.substring(0, 50) + '...'"></div>
            </div>
        </div>
    </div>

    <script>
        function javStudio() {
            return {
                // Core State
                systemHealth: 'Loading...',
                hasErrors: false,
                hasWarnings: false,
                totalMemories: 0,

                // Memory & Context
                studioItems: [],
                studioStatus: 'Initializing living project brain...',
                codeInsight: null,

                // Conversation
                conversationHistory: [],
                chatMessage: '',
                javTyping: false,

                // Implementation
                activeImplementation: null,
                implementationHistory: [],

                // Drag & Drop
                dragActive: false,
                dragging: false,
                dragX: 0,
                dragY: 0,
                draggedItem: null,

                // Initialize the workspace
                async init() {
                    console.log('🚀 Initializing Jav Studio...');
                    await this.loadSystemHealth();
                    await this.loadMemoryBrain();
                    await this.loadConversationHistory();
                    this.startPeriodicUpdates();
                    this.showWelcomeInsight();
                },

                // Load system health and memory status
                async loadSystemHealth() {
                    try {
                        const response = await fetch('/health');
                        const health = await response.json();

                        this.systemHealth = health.status || 'unknown';
                        this.hasErrors = health.status === 'unhealthy' || health.status === 'error';
                        this.hasWarnings = health.status === 'degraded';
                    } catch (error) {
                        console.error('Health check failed:', error);
                        this.systemHealth = 'offline';
                        this.hasErrors = true;
                    }
                },

                // Load memory brain data
                async loadMemoryBrain() {
                    try {
                        const response = await fetch('/memory?limit=20');
                        const data = await response.json();

                        this.totalMemories = data.memories?.length || 0;

                        // Transform memories into studio items
                        this.studioItems = (data.memories || []).map(memory => ({
                            id: memory.timestamp || Date.now(),
                            title: memory.topic || 'Untitled Memory',
                            preview: memory.input?.substring(0, 80) + '...' || 'No preview',
                            icon: this.getMemoryIcon(memory.type),
                            timeAgo: this.getTimeAgo(memory.timestamp),
                            type: memory.type,
                            memory: memory
                        }));

                        this.studioStatus = `Living brain with ${this.totalMemories} memories active`;
                    } catch (error) {
                        console.error('Failed to load memory brain:', error);
                        this.studioStatus = 'Memory brain offline - working in isolation mode';
                    }
                },

                // Load conversation history from memories
                async loadConversationHistory() {
                    try {
                        const response = await fetch('/memory?category=conversation&limit=10');
                        const data = await response.json();

                        this.conversationHistory = (data.memories || [])
                            .filter(m => m.category === 'conversation')
                            .map(memory => ({
                                id: memory.timestamp,
                                role: memory.type === 'user_input' ? 'user' : 'assistant',
                                content: memory.output || memory.input,
                                timestamp: this.formatTimestamp(memory.timestamp),
                                implementations: memory.implementations || []
                            }));
                    } catch (error) {
                        console.error('Failed to load conversation history:', error);
                    }
                },

                // Start creative session
                startCreativeSession() {
                    this.codeInsight = {
                        title: 'Welcome to Jav Studio',
                        message: 'Your memory-driven creative workspace is ready. Every conversation, idea, and implementation will be remembered and connected.'
                    };

                    this.conversationHistory.push({
                        id: Date.now(),
                        role: 'assistant',
                        content: '🌟 Welcome to your creative workspace! I\'m Jav, your memory-driven AI partner. I remember everything we build together, so we can compound our creativity session after session.\n\nWhat would you like to create today?',
                        timestamp: this.formatTimestamp(new Date().toISOString())
                    });

                    this.scrollToBottom();
                },

                // Send message to Jav
                async sendMessage() {
                    if (!this.chatMessage.trim() || this.javTyping) return;

                    const userMessage = this.chatMessage.trim();
                    this.chatMessage = '';

                    // Add user message to history
                    this.conversationHistory.push({
                        id: Date.now(),
                        role: 'user',
                        content: userMessage,
                        timestamp: this.formatTimestamp(new Date().toISOString())
                    });

                    this.scrollToBottom();
                    this.javTyping = true;

                    try {
                        // Send to Jav AI endpoint
                        const response = await fetch('/jav/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: userMessage,
                                context: 'creative_studio'
                            })
                        });

                        const result = await response.json();

                        if (result.status === 'success') {
                            // Add Jav's response
                            this.conversationHistory.push({
                                id: Date.now() + 1,
                                role: 'assistant',
                                content: result.response.message || result.response,
                                timestamp: this.formatTimestamp(new Date().toISOString()),
                                implementations: result.response.implementations || []
                            });

                            // Check for implementations
                            if (result.response.implementations && result.response.implementations.length > 0) {
                                this.activeImplementation = result.response.implementations[0];
                            }
                        } else {
                            throw new Error(result.error || 'Unknown error');
                        }
                    } catch (error) {
                        console.error('Chat error:', error);
                        this.conversationHistory.push({
                            id: Date.now() + 1,
                            role: 'assistant',
                            content: `I encountered an error: ${error.message}. But don't worry - I'm still here and our conversation is being saved to memory for next time!`,
                            timestamp: this.formatTimestamp(new Date().toISOString())
                        });
                    } finally {
                        this.javTyping = false;
                        this.scrollToBottom();
                        await this.loadMemoryBrain(); // Refresh memory brain
                    }
                },

                // Handle Enter key
                handleEnter(event) {
                    if (event.ctrlKey || event.metaKey) {
                        this.sendMessage();
                    }
                },

                // Handle input changes
                handleInput() {
                    // Limit message length
                    if (this.chatMessage.length > 500) {
                        this.chatMessage = this.chatMessage.substring(0, 500);
                    }
                },

                // Handle drag and drop
                handleDrop(event) {
                    this.dragActive = false;
                    const files = Array.from(event.dataTransfer.files);
                    const text = event.dataTransfer.getData('text');

                    if (files.length > 0) {
                        this.handleFilesDrop(files);
                    } else if (text) {
                        this.handleTextDrop(text);
                    }
                },

                // Handle dropped files
                async handleFilesDrop(files) {
                    for (const file of files) {
                        const text = await file.text();
                        this.chatMessage = `Analyze this ${file.name} file:\n\`\`\`\n${text.substring(0, 1000)}${text.length > 1000 ? '...' : ''}\n\`\`\``;
                        break; // Handle first file only for now
                    }
                },

                // Handle dropped text
                handleTextDrop(text) {
                    this.chatMessage = `Help me with this: ${text}`;
                },

                // Focus on a memory
                focusMemory(item) {
                    this.codeInsight = {
                        title: `Memory: ${item.title}`,
                        message: `Reviewing memory from ${item.timeAgo}. This will inform our current conversation.`
                    };

                    // Add memory context to conversation
                    this.conversationHistory.push({
                        id: Date.now(),
                        role: 'assistant',
                        content: `📚 I'm reviewing this memory: "${item.title}"\n\nOriginal context: ${item.memory.input}\n\nHow does this relate to what we're working on now?`,
                        timestamp: this.formatTimestamp(new Date().toISOString())
                    });

                    this.scrollToBottom();
                },

                // Implementation functions
                async applyImplementation() {
                    if (!this.activeImplementation) return;

                    // Here you would integrate with Replit's file system
                    console.log('Applying implementation:', this.activeImplementation);

                    // Add to history
                    this.implementationHistory.unshift({
                        ...this.activeImplementation,
                        appliedAt: new Date().toISOString()
                    });

                    this.activeImplementation = null;

                    // Show success message
                    this.conversationHistory.push({
                        id: Date.now(),
                        role: 'assistant',
                        content: '✅ Implementation applied! The changes have been integrated into your project and saved to memory.',
                        timestamp: this.formatTimestamp(new Date().toISOString())
                    });

                    this.scrollToBottom();
                },

                previewImplementation() {
                    // Show diff preview
                    console.log('Previewing implementation:', this.activeImplementation);
                },

                editImplementation() {
                    // Open implementation for editing
                    console.log('Editing implementation:', this.activeImplementation);
                },

                implementCode(impl) {
                    this.activeImplementation = impl;
                },

                reviewImplementation(impl) {
                    this.activeImplementation = impl;
                },

                // Utility functions
                getMemoryIcon(type) {
                    const icons = {
                        'SystemUpdate': '⚙️',
                        'Feature': '✨',
                        'BugFix': '🐛',
                        'Interaction': '💬',
                        'UserInteraction': '👤',
                        'user_input': '💭',
                        'ai_response': '🤖',
                        'conversation': '💬'
                    };
                    return icons[type] || '📝';
                },

                getTimeAgo(timestamp) {
                    if (!timestamp) return 'Unknown';
                    const now = new Date();
                    const time = new Date(timestamp);
                    const diff = now - time;
                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(hours / 24);

                    if (days > 0) return `${days}d ago`;
                    if (hours > 0) return `${hours}h ago`;
                    if (minutes > 0) return `${minutes}m ago`;
                    return 'Just now';
                },

                formatTimestamp(timestamp) {
                    return new Date(timestamp).toLocaleString();
                },

                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = this.$refs.conversationContainer;
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                },

                showWelcomeInsight() {
                    setTimeout(() => {
                        if (this.conversationHistory.length === 0) {
                            this.codeInsight = {
                                title: 'Your Living Project Brain is Active',
                                message: 'Every conversation, decision, and creative breakthrough will be captured and connected. Start building!'
                            };
                        }
                    }, 2000);
                },

                // Periodic updates
                startPeriodicUpdates() {
                    setInterval(() => {
                        this.loadSystemHealth();
                        this.loadMemoryBrain();
                    }, 30000); // Every 30 seconds
                }
            };
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jav Co-Builder - Memory-Driven Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --jav-primary: #3B82F6;
            --jav-primary-dark: #1E40AF;
            --jav-accent: #10B981;
            --jav-bg: #0F172A;
            --jav-surface: #1E293B;
            --jav-panel: #334155;
            --jav-border: #475569;
            --jav-text: #F8FAFC;
            --jav-text-muted: #94A3B8;
            --jav-success: #10B981;
            --jav-warning: #F59E0B;
            --jav-error: #EF4444;
        }
        
        body {
            background: var(--jav-bg);
            color: var(--jav-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        
        .workspace-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .main-canvas {
            flex: 1;
            position: relative;
            background: var(--jav-bg);
            overflow: hidden;
        }
        
        .jav-context-panel {
            position: fixed;
            right: 24px;
            top: 24px;
            width: 380px;
            max-height: 70vh;
            background: var(--jav-surface);
            border: 1px solid var(--jav-border);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .jav-context-panel.minimized {
            height: 60px;
            max-height: 60px;
        }
        
        .context-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--jav-border);
            display: flex;
            align-items: center;
            justify-content: between;
            cursor: pointer;
            background: linear-gradient(135deg, var(--jav-primary), var(--jav-accent));
            color: white;
        }
        
        .context-content {
            max-height: calc(70vh - 60px);
            overflow-y: auto;
            padding: 0;
        }
        
        .suggestion-card {
            margin: 12px;
            padding: 16px;
            background: var(--jav-panel);
            border-radius: 12px;
            border-left: 4px solid var(--jav-primary);
            transition: all 0.2s ease;
            animation: slideInRight 0.3s ease;
        }
        
        .suggestion-card:hover {
            background: #475569;
            transform: translateX(-2px);
        }
        
        .suggestion-card.error {
            border-left-color: var(--jav-error);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .suggestion-card.warning {
            border-left-color: var(--jav-warning);
            background: rgba(245, 158, 11, 0.1);
        }
        
        .suggestion-card.success {
            border-left-color: var(--jav-success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .suggestion-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .action-btn.primary {
            background: var(--jav-primary);
            color: white;
        }
        
        .action-btn.primary:hover {
            background: var(--jav-primary-dark);
        }
        
        .action-btn.secondary {
            background: var(--jav-panel);
            color: var(--jav-text-muted);
            border: 1px solid var(--jav-border);
        }
        
        .action-btn.secondary:hover {
            background: var(--jav-border);
            color: var(--jav-text);
        }
        
        .jav-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--jav-success);
            animation: pulse 2s infinite;
            margin-right: 8px;
        }
        
        .jav-status-indicator.thinking {
            background: var(--jav-warning);
            animation: blink 1s infinite;
        }
        
        .jav-status-indicator.error {
            background: var(--jav-error);
            animation: none;
        }
        
        .activity-log {
            padding: 16px 20px;
            border-top: 1px solid var(--jav-border);
            background: rgba(0, 0, 0, 0.2);
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            font-size: 13px;
            color: var(--jav-text-muted);
        }
        
        .activity-item .icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
        }
        
        .mini-thread {
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid var(--jav-border);
        }
        
        .thread-message {
            padding: 12px 20px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            font-size: 13px;
        }
        
        .thread-message.jav {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .thread-message.user {
            background: rgba(16, 185, 129, 0.05);
        }
        
        .jav-avatar {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--jav-primary), var(--jav-accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);
        }
        
        .jav-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 48px rgba(59, 130, 246, 0.6);
        }
        
        .jav-avatar.active {
            background: linear-gradient(135deg, var(--jav-accent), var(--jav-primary));
            animation: pulse 2s infinite;
        }
        
        .jav-chat-panel {
            position: fixed;
            right: 24px;
            bottom: 104px;
            width: 400px;
            height: 500px;
            background: var(--jav-surface);
            border: 1px solid var(--jav-border);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 998;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .jav-chat-panel.visible {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        
        .toolbar {
            position: fixed;
            top: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
            z-index: 200;
        }
        
        .toolbar-button {
            width: 40px;
            height: 40px;
            background: var(--jav-surface);
            border: 1px solid var(--jav-border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .toolbar-button:hover {
            background: var(--jav-panel);
            border-color: var(--jav-primary);
        }
        
        .toolbar-button.active {
            background: var(--jav-primary);
            color: white;
        }
        
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: var(--jav-surface);
            border-top: 1px solid var(--jav-border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-size: 12px;
            z-index: 100;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .personality-badge {
            font-size: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div x-data="javWorkspace()" x-init="init()" class="workspace-container">
        
        <!-- Main Canvas - Code Editor -->
        <div class="main-canvas" @click="hideContextMenus()">
            <div id="monaco-editor" class="w-full h-full"></div>
        </div>
        
        <!-- Jav Context Panel - The Heart of the Copilot -->
        <div class="jav-context-panel" 
             :class="{ 'minimized': contextMinimized }"
             x-show="contextPanelVisible"
             x-transition>
            
            <!-- Context Header -->
            <div class="context-header" @click="toggleContextPanel()">
                <div class="flex items-center">
                    <div class="jav-status-indicator" 
                         :class="{ 'thinking': javThinking, 'error': hasErrors }"></div>
                    <div>
                        <div class="font-medium">Jav Context</div>
                        <div class="text-xs opacity-80" x-text="contextStatus"></div>
                    </div>
                    <div class="personality-badge" x-text="personalityMode"></div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs" x-text="activeSuggestions + ' active'"></span>
                    <i class="fas fa-chevron-down transition-transform" 
                       :class="{ 'rotate-180': !contextMinimized }"></i>
                </div>
            </div>
            
            <!-- Context Content -->
            <div class="context-content" x-show="!contextMinimized">
                
                <!-- Contextual Suggestions -->
                <div x-show="suggestions.length > 0">
                    <template x-for="suggestion in suggestions" :key="suggestion.id">
                        <div class="suggestion-card" 
                             :class="suggestion.type"
                             x-transition:enter="fade-in">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <i :class="suggestion.icon" class="text-sm"></i>
                                    <span class="font-medium text-sm" x-text="suggestion.title"></span>
                                </div>
                                <span class="text-xs text-gray-400" x-text="timeAgo(suggestion.timestamp)"></span>
                            </div>
                            <div class="text-sm text-gray-300 mb-3" x-text="suggestion.message"></div>
                            <div class="suggestion-actions">
                                <template x-for="action in suggestion.actions" :key="action.id">
                                    <button class="action-btn" 
                                            :class="action.type"
                                            @click="executeAction(action, suggestion)"
                                            x-text="action.label"></button>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- What's Jav Doing Section -->
                <div class="activity-log" x-show="currentActivity.length > 0">
                    <div class="text-sm font-medium mb-3 flex items-center">
                        <i class="fas fa-cog animate-spin mr-2"></i>
                        What's Jav Doing?
                    </div>
                    <template x-for="activity in currentActivity" :key="activity.id">
                        <div class="activity-item">
                            <div class="icon" :style="`background: ${activity.color}`">
                                <i :class="activity.icon" class="text-white"></i>
                            </div>
                            <span x-text="activity.description"></span>
                            <div class="ml-auto text-xs" x-text="activity.status"></div>
                        </div>
                    </template>
                </div>
                
                <!-- Mini Thread / Recent Exchanges -->
                <div class="mini-thread" x-show="recentExchanges.length > 0">
                    <template x-for="exchange in recentExchanges.slice(-3)" :key="exchange.id">
                        <div class="thread-message" :class="exchange.type">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-medium" 
                                      x-text="exchange.type === 'jav' ? 'Jav' : 'You'"></span>
                                <span class="text-xs text-gray-400" x-text="timeAgo(exchange.timestamp)"></span>
                            </div>
                            <div class="text-sm" x-text="exchange.message"></div>
                        </div>
                    </template>
                </div>
                
                <!-- Empty State -->
                <div x-show="suggestions.length === 0 && currentActivity.length === 0" 
                     class="p-8 text-center text-gray-400">
                    <i class="fas fa-robot text-3xl mb-4 opacity-50"></i>
                    <div class="text-sm">I'm watching your back! 👀</div>
                    <div class="text-xs mt-1">Ready to help when you need me.</div>
                </div>
            </div>
        </div>
        
        <!-- Jav Avatar -->
        <div class="jav-avatar" 
             :class="{ 'active': javActive }"
             @click="toggleJavChat()"
             title="Click to chat with Jav">
            <i class="fas fa-robot text-xl text-white"></i>
        </div>
        
        <!-- Jav Chat Panel -->
        <div class="jav-chat-panel" 
             :class="{ 'visible': javChatVisible }"
             x-show="javChatVisible"
             x-transition>
            <div class="context-header">
                <div class="flex items-center gap-2">
                    <i class="fas fa-robot text-blue-400"></i>
                    <span class="font-medium">Chat with Jav</span>
                    <div class="personality-badge" x-text="personalityMode"></div>
                </div>
                <button @click="toggleJavChat()" class="text-xs hover:text-red-400">×</button>
            </div>
            <div class="flex flex-col h-full">
                <div class="flex-1 overflow-y-auto p-4 space-y-3">
                    <template x-for="message in javMessages">
                        <div class="flex gap-3" :class="message.type === 'user' ? 'justify-end' : 'justify-start'">
                            <div x-show="message.type === 'jav'" 
                                 class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-robot text-white text-xs"></i>
                            </div>
                            <div class="max-w-xs p-3 rounded-xl text-sm"
                                 :class="message.type === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-200'">
                                <div x-text="message.text"></div>
                                <div class="text-xs opacity-70 mt-1" x-text="formatTime(message.timestamp)"></div>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="border-t border-gray-600 p-3">
                    <div class="flex gap-2">
                        <input x-model="javInput" 
                               @keydown.enter="sendToJav()"
                               placeholder="What's up?"
                               class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                        <button @click="sendToJav()" 
                                class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-lg">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Toolbar -->
        <div class="toolbar">
            <button @click="toggleContextPanel()" 
                    class="toolbar-button" 
                    :class="{ 'active': contextPanelVisible }"
                    title="Toggle Jav Context (Ctrl+J)">
                <i class="fas fa-brain"></i>
            </button>
            <button @click="runQuickAction('health')" 
                    class="toolbar-button"
                    title="Health Check (Ctrl+H)">
                <i class="fas fa-heart-pulse"></i>
            </button>
            <button @click="runQuickAction('test')" 
                    class="toolbar-button"
                    title="Run Tests (Ctrl+T)">
                <i class="fas fa-vial"></i>
            </button>
            <button @click="cyclePersonality()" 
                    class="toolbar-button"
                    title="Change Jav's Personality">
                <i class="fas fa-theater-masks"></i>
            </button>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="flex items-center gap-4">
                <span class="flex items-center gap-1">
                    <div class="w-2 h-2 rounded-full" 
                         :class="javActive ? 'bg-green-400' : 'bg-gray-400'"></div>
                    <span x-text="javActive ? 'Jav Active' : 'Jav Idle'"></span>
                </span>
                <span x-text="activeFile || 'No file open'"></span>
                <span x-text="'Context: ' + activeSuggestions + ' suggestions'"></span>
                <span class="ml-auto" x-text="'Session: ' + sessionId.substring(0, 8)"></span>
            </div>
        </div>
    </div>

    <script>
        function javWorkspace() {
            return {
                // Core State
                sessionId: new Date().toISOString().replace(/[-:]/g, '').split('.')[0],
                javActive: true,
                javThinking: false,
                hasErrors: false,
                
                // Context Panel State
                contextPanelVisible: true,
                contextMinimized: false,
                contextStatus: 'All systems go! 🚀',
                activeSuggestions: 0,
                
                // Personality System
                personalityMode: 'Friendly',
                personalities: ['Friendly', 'Professional', 'Casual', 'Motivational', 'Sarcastic'],
                personalityIndex: 0,
                
                // Chat State
                javChatVisible: false,
                javMessages: [],
                javInput: '',
                
                // Contextual Intelligence
                suggestions: [],
                currentActivity: [],
                recentExchanges: [],
                
                // Editor State
                editor: null,
                activeFile: 'main.py',
                lastCodeChange: null,
                
                async init() {
                    console.log('🚀 Initializing Jav Builder...');
                    
                    // Initialize Monaco Editor
                    this.initializeEditor();
                    
                    // Load system data
                    await this.loadSystemData();
                    
                    // Setup keyboard shortcuts
                    this.setupKeyboardShortcuts();
                    
                    // Start Jav intelligence
                    this.startJavIntelligence();
                    
                    // Welcome message
                    this.addContextSuggestion({
                        type: 'success',
                        icon: 'fas fa-rocket',
                        title: 'Welcome back!',
                        message: 'I\'m ready to help you build amazing things. What are we working on today?',
                        actions: [
                            { id: 'start-coding', label: 'Start Coding', type: 'primary' },
                            { id: 'show-health', label: 'Health Check', type: 'secondary' }
                        ]
                    });
                    
                    console.log('✅ System data loaded successfully');
                },
                
                initializeEditor() {
                    require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.45.0/min/vs' }});
                    require(['vs/editor/editor.main'], () => {
                        this.editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                            value: '# Welcome to Jav Co-Builder\n# Your AI copilot is actively watching and ready to help\n\nprint("Building with Jav!")\n\n# Try making changes to see contextual suggestions\n# Jav learns your patterns and suggests improvements',
                            language: 'python',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: { enabled: false },
                            fontSize: 14,
                            lineNumbers: 'on',
                            roundedSelection: false,
                            scrollBeyondLastLine: false,
                            readOnly: false
                        });
                        
                        // Real-time code analysis
                        this.editor.onDidChangeModelContent(() => {
                            this.analyzeCodeIntelligently();
                        });
                        
                        // Cursor position awareness
                        this.editor.onDidChangeCursorPosition((e) => {
                            this.updateContextAwareness(e);
                        });
                        
                        // Error detection
                        this.editor.onDidChangeMarkers(() => {
                            this.handleEditorErrors();
                        });
                    });
                },
                
                async loadSystemData() {
                    try {
                        // Load health and memory stats
                        const [healthResponse, statsResponse] = await Promise.all([
                            fetch('/health'),
                            fetch('/stats')
                        ]);
                        
                        if (healthResponse.ok) {
                            const healthData = await healthResponse.json();
                            if (healthData.status !== 'healthy') {
                                this.addContextSuggestion({
                                    type: 'error',
                                    icon: 'fas fa-exclamation-triangle',
                                    title: 'System Health Issue',
                                    message: `Health check reports: ${healthData.status}. Should I investigate?`,
                                    actions: [
                                        { id: 'fix-health', label: 'Auto-Fix', type: 'primary' },
                                        { id: 'explain-health', label: 'Explain', type: 'secondary' },
                                        { id: 'dismiss-health', label: 'Dismiss', type: 'secondary' }
                                    ]
                                });
                                this.hasErrors = true;
                            }
                        }
                        
                        if (statsResponse.ok) {
                            const statsData = await statsResponse.json();
                            const successRate = parseFloat(statsData.success_rate);
                            
                            if (successRate < 80) {
                                this.addContextSuggestion({
                                    type: 'warning',
                                    icon: 'fas fa-chart-line',
                                    title: 'Success Rate Low',
                                    message: `Your success rate is ${statsData.success_rate}. Want me to analyze recent failures?`,
                                    actions: [
                                        { id: 'analyze-failures', label: 'Analyze', type: 'primary' },
                                        { id: 'dismiss-rate', label: 'Later', type: 'secondary' }
                                    ]
                                });
                            }
                        }
                        
                    } catch (error) {
                        console.error('Failed to load system data:', error);
                        this.addContextSuggestion({
                            type: 'error',
                            icon: 'fas fa-wifi',
                            title: 'Connection Issue',
                            message: 'Can\'t reach the backend. Should I try to reconnect?',
                            actions: [
                                { id: 'retry-connection', label: 'Retry', type: 'primary' },
                                { id: 'work-offline', label: 'Work Offline', type: 'secondary' }
                            ]
                        });
                    }
                },
                
                setupKeyboardShortcuts() {
                    document.addEventListener('keydown', (e) => {
                        if (e.ctrlKey || e.metaKey) {
                            switch(e.code) {
                                case 'KeyJ':
                                    e.preventDefault();
                                    this.toggleContextPanel();
                                    break;
                                case 'KeyH':
                                    e.preventDefault();
                                    this.runQuickAction('health');
                                    break;
                                case 'KeyT':
                                    e.preventDefault();
                                    this.runQuickAction('test');
                                    break;
                            }
                        }
                    });
                },
                
                startJavIntelligence() {
                    // Periodic context analysis
                    setInterval(() => {
                        this.generateContextualSuggestions();
                    }, 15000); // Every 15 seconds
                    
                    // Activity monitoring
                    setInterval(() => {
                        this.updateCurrentActivity();
                    }, 3000); // Every 3 seconds
                    
                    // Motivational nudges
                    setInterval(() => {
                        this.generateMotivationalNudges();
                    }, 120000); // Every 2 minutes
                },
                
                analyzeCodeIntelligently() {
                    if (!this.editor) return;
                    
                    this.javThinking = true;
                    this.lastCodeChange = Date.now();
                    
                    setTimeout(() => {
                        const code = this.editor.getValue();
                        
                        // Smart contextual suggestions
                        if (code.includes('def ') && !code.includes('"""')) {
                            this.addContextSuggestion({
                                type: 'suggestion',
                                icon: 'fas fa-file-alt',
                                title: 'Add Docstring?',
                                message: 'I noticed you added a function. Want me to generate a docstring?',
                                actions: [
                                    { id: 'add-docstring', label: 'Add Docstring', type: 'primary' },
                                    { id: 'remind-later', label: 'Remind Later', type: 'secondary' },
                                    { id: 'dismiss-docstring', label: 'Skip', type: 'secondary' }
                                ]
                            });
                        }
                        
                        if (code.includes('TODO') || code.includes('FIXME')) {
                            this.addContextSuggestion({
                                type: 'warning',
                                icon: 'fas fa-sticky-note',
                                title: 'TODO Detected',
                                message: 'Found some TODOs. Should I help you tackle them or track them?',
                                actions: [
                                    { id: 'show-todos', label: 'Show All', type: 'primary' },
                                    { id: 'track-todos', label: 'Track', type: 'secondary' }
                                ]
                            });
                        }
                        
                        if (code.includes('import ') && code.split('\n').length > 10) {
                            this.addContextSuggestion({
                                type: 'suggestion',
                                icon: 'fas fa-broom',
                                title: 'Clean up imports?',
                                message: 'Your file is growing. Want me to organize the imports?',
                                actions: [
                                    { id: 'organize-imports', label: 'Organize', type: 'primary' },
                                    { id: 'later-imports', label: 'Later', type: 'secondary' }
                                ]
                            });
                        }
                        
                        this.javThinking = false;
                    }, 1000); // 1 second delay for intelligent analysis
                },
                
                generateContextualSuggestions() {
                    const now = Date.now();
                    const timeSinceLastChange = now - (this.lastCodeChange || now);
                    
                    // Time-based suggestions
                    if (timeSinceLastChange > 300000) { // 5 minutes idle
                        this.addContextSuggestion({
                            type: 'suggestion',
                            icon: 'fas fa-coffee',
                            title: 'Taking a break?',
                            message: this.getPersonalizedMessage('idle'),
                            actions: [
                                { id: 'run-tests', label: 'Run Tests', type: 'primary' },
                                { id: 'commit-work', label: 'Commit Progress', type: 'secondary' },
                                { id: 'review-code', label: 'Code Review', type: 'secondary' }
                            ]
                        });
                    }
                    
                    // Smart suggestions based on current context
                    if (Math.random() < 0.3) { // 30% chance for proactive suggestions
                        const smartSuggestions = [
                            {
                                type: 'suggestion',
                                icon: 'fas fa-rocket',
                                title: 'Ready to test?',
                                message: 'Your code looks solid. Want to run some tests?',
                                actions: [
                                    { id: 'run-tests', label: 'Run Tests', type: 'primary' },
                                    { id: 'write-tests', label: 'Write Tests', type: 'secondary' }
                                ]
                            },
                            {
                                type: 'suggestion',
                                icon: 'fas fa-shield-alt',
                                title: 'Error handling check',
                                message: 'Should I scan for potential error cases?',
                                actions: [
                                    { id: 'scan-errors', label: 'Scan Now', type: 'primary' },
                                    { id: 'add-try-catch', label: 'Add Error Handling', type: 'secondary' }
                                ]
                            }
                        ];
                        
                        const suggestion = smartSuggestions[Math.floor(Math.random() * smartSuggestions.length)];
                        this.addContextSuggestion(suggestion);
                    }
                },
                
                generateMotivationalNudges() {
                    if (this.suggestions.length === 0) { // Only when not busy
                        const motivationalMessages = {
                            'Friendly': [
                                '🌟 You\'re doing great! Keep up the awesome work!',
                                '💪 I believe in you! What\'s our next move?',
                                '🚀 Ready to build something amazing together?'
                            ],
                            'Professional': [
                                '📋 System status optimal. Ready for next task.',
                                '⚡ All systems operational. Awaiting instructions.',
                                '🎯 Ready to execute your next objective.'
                            ],
                            'Casual': [
                                '😎 Chillin\' and ready to code when you are!',
                                '🤘 What\'s cooking? Ready to rock some code?',
                                '✌️ Just vibing here, ready to help!'
                            ],
                            'Motivational': [
                                '🔥 You\'re on fire today! Let\'s crush some more goals!',
                                '⭐ Every line of code is progress. You\'ve got this!',
                                '🏆 Champions code every day. Ready for the next challenge?'
                            ],
                            'Sarcastic': [
                                '🙄 Well, this is exciting... kidding! What are we building?',
                                '😏 I\'m just sitting here being incredibly helpful...',
                                '🤖 Beep boop. Your friendly sarcastic AI awaits commands.'
                            ]
                        };
                        
                        const messages = motivationalMessages[this.personalityMode] || motivationalMessages['Friendly'];
                        const message = messages[Math.floor(Math.random() * messages.length)];
                        
                        this.addContextSuggestion({
                            type: 'success',
                            icon: 'fas fa-heart',
                            title: 'Jav Check-in',
                            message: message,
                            actions: [
                                { id: 'thanks-jav', label: 'Thanks!', type: 'primary' },
                                { id: 'show-stats', label: 'Show Stats', type: 'secondary' }
                            ]
                        });
                    }
                },
                
                updateCurrentActivity() {
                    // Simulate real-time activity monitoring
                    this.currentActivity = [
                        {
                            id: 'health-monitor',
                            icon: 'fas fa-heart-pulse',
                            description: 'Monitoring system health',
                            status: 'Active',
                            color: '#10B981'
                        },
                        {
                            id: 'code-analysis',
                            icon: 'fas fa-search',
                            description: 'Analyzing code patterns',
                            status: this.javThinking ? 'Running' : 'Idle',
                            color: this.javThinking ? '#F59E0B' : '#6B7280'
                        },
                        {
                            id: 'memory-sync',
                            icon: 'fas fa-sync',
                            description: 'Syncing memory data',
                            status: 'Standby',
                            color: '#3B82F6'
                        }
                    ];
                },
                
                getPersonalizedMessage(context) {
                    const personalizedMessages = {
                        idle: {
                            'Friendly': 'Hey! Need a gentle nudge to get back into the flow?',
                            'Professional': 'Extended idle period detected. Recommend status review.',
                            'Casual': 'Yo! Taking a break or should we get back to it?',
                            'Motivational': 'Every break is a chance to come back stronger! Ready?',
                            'Sarcastic': 'Oh, are we having a staring contest with the code?'
                        }
                    };
                    
                    return personalizedMessages[context]?.[this.personalityMode] || 
                           personalizedMessages[context]?.['Friendly'] || 
                           'How can I help?';
                },
                
                addContextSuggestion(suggestion) {
                    suggestion.id = Date.now() + Math.random();
                    suggestion.timestamp = new Date();
                    
                    this.suggestions.unshift(suggestion);
                    this.activeSuggestions = this.suggestions.length;
                    
                    // Keep only recent suggestions
                    if (this.suggestions.length > 5) {
                        this.suggestions = this.suggestions.slice(0, 5);
                    }
                    
                    // Auto-dismiss after 30 seconds for non-critical suggestions
                    if (suggestion.type === 'suggestion') {
                        setTimeout(() => {
                            this.dismissSuggestion(suggestion.id);
                        }, 30000);
                    }
                },
                
                dismissSuggestion(suggestionId) {
                    this.suggestions = this.suggestions.filter(s => s.id !== suggestionId);
                    this.activeSuggestions = this.suggestions.length;
                },
                
                async executeAction(action, suggestion) {
                    this.addRecentExchange('user', `Executed: ${action.label}`);
                    
                    switch(action.id) {
                        case 'run-tests':
                            await this.runQuickAction('test');
                            break;
                        case 'fix-health':
                            await this.runQuickAction('health');
                            break;
                        case 'add-docstring':
                            this.addRecentExchange('jav', 'Added docstring template to your function!');
                            break;
                        case 'organize-imports':
                            this.addRecentExchange('jav', 'Organized your imports - looking clean! ✨');
                            break;
                        case 'thanks-jav':
                            this.addRecentExchange('jav', 'You\'re welcome! I love working with you! 💙');
                            break;
                        default:
                            this.addRecentExchange('jav', `Executed ${action.label}`);
                    }
                    
                    this.dismissSuggestion(suggestion.id);
                },
                
                addRecentExchange(type, message) {
                    this.recentExchanges.push({
                        id: Date.now(),
                        type: type,
                        message: message,
                        timestamp: new Date()
                    });
                    
                    // Keep only recent 10 exchanges
                    if (this.recentExchanges.length > 10) {
                        this.recentExchanges = this.recentExchanges.slice(-10);
                    }
                },
                
                // UI Controls
                toggleContextPanel() {
                    if (this.contextPanelVisible) {
                        this.contextMinimized = !this.contextMinimized;
                    } else {
                        this.contextPanelVisible = true;
                        this.contextMinimized = false;
                    }
                },
                
                toggleJavChat() {
                    this.javChatVisible = !this.javChatVisible;
                    if (this.javChatVisible) {
                        this.javActive = true;
                        setTimeout(() => {
                            const input = document.querySelector('.jav-chat-panel input');
                            if (input) input.focus();
                        }, 100);
                    }
                },
                
                cyclePersonality() {
                    this.personalityIndex = (this.personalityIndex + 1) % this.personalities.length;
                    this.personalityMode = this.personalities[this.personalityIndex];
                    
                    this.addContextSuggestion({
                        type: 'success',
                        icon: 'fas fa-theater-masks',
                        title: 'Personality Changed',
                        message: `I'm now in ${this.personalityMode} mode! How does this feel?`,
                        actions: [
                            { id: 'perfect-personality', label: 'Perfect!', type: 'primary' },
                            { id: 'try-another', label: 'Try Another', type: 'secondary' }
                        ]
                    });
                },
                
                async sendToJav() {
                    if (!this.javInput.trim()) return;
                    
                    const userMessage = this.javInput;
                    this.javInput = '';
                    
                    this.javMessages.push({
                        type: 'user',
                        text: userMessage,
                        timestamp: new Date().toISOString()
                    });
                    
                    this.addRecentExchange('user', userMessage);
                    
                    try {
                        const response = await fetch('/jav/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: userMessage })
                        });
                        
                        const data = await response.json();
                        let javResponse = 'I got your message! How can I help?';
                        
                        if (data.status === 'success') {
                            javResponse = data.response.message || javResponse;
                        }
                        
                        this.javMessages.push({
                            type: 'jav',
                            text: javResponse,
                            timestamp: new Date().toISOString()
                        });
                        
                        this.addRecentExchange('jav', javResponse);
                        
                    } catch (error) {
                        const errorResponse = 'Sorry, I\'m having connection issues. But I\'m still here to help!';
                        this.javMessages.push({
                            type: 'jav',
                            text: errorResponse,
                            timestamp: new Date().toISOString()
                        });
                    }
                },
                
                async runQuickAction(action) {
                    this.javThinking = true;
                    this.addRecentExchange('user', `Running ${action}...`);
                    
                    switch(action) {
                        case 'health':
                            try {
                                const response = await fetch('/health');
                                const data = await response.json();
                                const message = data.status === 'healthy' ? 
                                    '✅ All systems healthy!' : 
                                    `⚠️ Health check: ${data.status}`;
                                this.addRecentExchange('jav', message);
                            } catch (error) {
                                this.addRecentExchange('jav', '❌ Health check failed');
                            }
                            break;
                        case 'test':
                            setTimeout(() => {
                                this.addRecentExchange('jav', '✅ Tests passed! Looking good.');
                            }, 2000);
                            break;
                    }
                    
                    setTimeout(() => {
                        this.javThinking = false;
                    }, 2000);
                },
                
                // Helper functions
                timeAgo(timestamp) {
                    const diff = Date.now() - new Date(timestamp).getTime();
                    const minutes = Math.floor(diff / 60000);
                    const seconds = Math.floor(diff / 1000);
                    
                    if (minutes > 0) return `${minutes}m ago`;
                    return `${seconds}s ago`;
                },
                
                formatTime(timestamp) {
                    try {
                        return new Date(timestamp).toLocaleTimeString();
                    } catch {
                        return timestamp;
                    }
                },
                
                hideContextMenus() {
                    // Implementation for hiding context menus
                },
                
                updateContextAwareness(event) {
                    // Update Jav's awareness of cursor position
                    this.javActive = true;
                },
                
                handleEditorErrors() {
                    // Handle editor error markers
                    const model = this.editor?.getModel();
                    if (model) {
                        const markers = monaco.editor.getModelMarkers({ resource: model.uri });
                        if (markers.length > 0) {
                            this.hasErrors = true;
                            this.addContextSuggestion({
                                type: 'error',
                                icon: 'fas fa-bug',
                                title: 'Syntax Error Detected',
                                message: `Found ${markers.length} syntax error(s). Want me to help fix them?`,
                                actions: [
                                    { id: 'fix-syntax', label: 'Auto-Fix', type: 'primary' },
                                    { id: 'explain-error', label: 'Explain', type: 'secondary' },
                                    { id: 'dismiss-error', label: 'Dismiss', type: 'secondary' }
                                ]
                            });
                        } else {
                            this.hasErrors = false;
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jav - Memory-Driven Workspace</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .workspace-grid {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            grid-template-rows: 60px 1fr 200px;
            height: 100vh;
            grid-template-areas: 
                "sidebar header terminal-header"
                "sidebar editor terminal"
                "sidebar preview logs";
        }
        .sidebar { grid-area: sidebar; }
        .header { grid-area: header; }
        .editor { grid-area: editor; }
        .terminal-header { grid-area: terminal-header; }
        .terminal { grid-area: terminal; }
        .preview { grid-area: preview; }
        .logs { grid-area: logs; }
        .resizer {
            background: #374151;
            cursor: col-resize;
            width: 5px;
        }
        .resizer:hover {
            background: #6366f1;
        }
        .monaco-editor-container {
            height: 100%;
            width: 100%;
        }
        .file-tree-item {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .file-tree-item:hover {
            background-color: #374151;
        }
        .file-tree-item.active {
            background-color: #4f46e5;
        }
        .terminal-output {
            font-family: 'Courier New', monospace;
            background: #1f2937;
            color: #e5e7eb;
            padding: 12px;
            height: 100%;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .command-input {
            background: #374151;
            border: none;
            color: #e5e7eb;
            font-family: 'Courier New', monospace;
            padding: 8px 12px;
            width: 100%;
        }
        .command-input:focus {
            outline: none;
            background: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden">
    <div x-data="javWorkspace()" x-init="init()" class="workspace-grid">
        <!-- Sidebar -->
        <div class="sidebar bg-gray-800 border-r border-gray-700 flex flex-col">
            <!-- Project Info -->
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-lg font-bold text-blue-400">Jav Workspace</h2>
                <p class="text-xs text-gray-400">Memory-Driven Builder</p>
            </div>
            
            <!-- File Tree -->
            <div class="flex-1 overflow-y-auto p-2">
                <div class="mb-4">
                    <h3 class="text-sm font-semibold text-gray-300 mb-2">Files</h3>
                    <template x-for="file in fileTree" :key="file.path">
                        <div 
                            class="file-tree-item text-sm"
                            :class="{ 'active': currentFile?.path === file.path }"
                            @click="openFile(file)"
                            x-text="file.name">
                        </div>
                    </template>
                </div>
                
                <!-- Memory Context -->
                <div class="mb-4">
                    <h3 class="text-sm font-semibold text-gray-300 mb-2">Memory Context</h3>
                    <div class="text-xs text-gray-400">
                        <div>Total: <span x-text="memoryStats.total"></span></div>
                        <div>Success: <span x-text="memoryStats.successRate"></span></div>
                        <div>Session: <span x-text="sessionId.substring(0, 8)"></span></div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mb-4">
                    <h3 class="text-sm font-semibold text-gray-300 mb-2">Quick Actions</h3>
                    <button @click="runHealthCheck()" class="w-full text-left text-xs p-2 bg-gray-700 rounded mb-1 hover:bg-gray-600">
                        Health Check
                    </button>
                    <button @click="createNewFile()" class="w-full text-left text-xs p-2 bg-gray-700 rounded mb-1 hover:bg-gray-600">
                        New File
                    </button>
                    <button @click="saveCurrentFile()" class="w-full text-left text-xs p-2 bg-blue-600 rounded mb-1 hover:bg-blue-500">
                        Save File
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Header -->
        <div class="header bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4">
            <div class="flex items-center space-x-4">
                <span class="text-sm" x-text="currentFile ? currentFile.name : 'No file open'"></span>
                <div class="flex space-x-2">
                    <button @click="runFile()" class="px-3 py-1 bg-green-600 rounded text-sm hover:bg-green-500">
                        Run
                    </button>
                    <button @click="deployProject()" class="px-3 py-1 bg-blue-600 rounded text-sm hover:bg-blue-500">
                        Deploy
                    </button>
                </div>
            </div>
            <div class="flex items-center space-x-2 text-sm text-gray-400">
                <span x-text="`${editorStatus}`"></span>
                <div class="w-2 h-2 rounded-full" :class="systemHealth === 'healthy' ? 'bg-green-500' : 'bg-red-500'"></div>
            </div>
        </div>
        
        <!-- Code Editor -->
        <div class="editor bg-gray-900">
            <div id="monaco-editor" class="monaco-editor-container"></div>
        </div>
        
        <!-- Terminal Header -->
        <div class="terminal-header bg-gray-800 border-b border-l border-gray-700 flex items-center px-4">
            <h3 class="text-sm font-semibold">Terminal</h3>
            <button @click="clearTerminal()" class="ml-auto text-xs px-2 py-1 bg-gray-700 rounded hover:bg-gray-600">
                Clear
            </button>
        </div>
        
        <!-- Terminal -->
        <div class="terminal bg-gray-900 border-l border-gray-700 flex flex-col">
            <div class="terminal-output flex-1" x-ref="terminalOutput" x-html="terminalOutput"></div>
            <div class="p-2 border-t border-gray-700">
                <input 
                    type="text" 
                    x-model="commandInput"
                    @keydown.enter="executeCommand()"
                    placeholder="$ Enter command..."
                    class="command-input">
            </div>
        </div>
        
        <!-- Preview -->
        <div class="preview bg-gray-900 border-l border-t border-gray-700">
            <div class="p-3 border-b border-gray-700 flex items-center justify-between">
                <h3 class="text-sm font-semibold">Live Preview</h3>
                <button @click="refreshPreview()" class="text-xs px-2 py-1 bg-gray-700 rounded hover:bg-gray-600">
                    Refresh
                </button>
            </div>
            <iframe 
                :src="previewUrl" 
                class="w-full h-full bg-white"
                x-ref="previewFrame">
            </iframe>
        </div>
        
        <!-- Logs -->
        <div class="logs bg-gray-900 border-l border-t border-gray-700">
            <div class="p-3 border-b border-gray-700">
                <h3 class="text-sm font-semibold">System Logs</h3>
            </div>
            <div class="p-3 text-xs overflow-y-auto h-full">
                <template x-for="log in systemLogs" :key="log.id">
                    <div class="mb-1" :class="log.level === 'error' ? 'text-red-400' : log.level === 'warning' ? 'text-yellow-400' : 'text-gray-300'">
                        <span class="text-gray-500" x-text="log.timestamp"></span>
                        <span x-text="log.message"></span>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        function javWorkspace() {
            return {
                // Core state
                currentFile: null,
                fileTree: [],
                memoryStats: { total: 0, successRate: '0%' },
                sessionId: '',
                systemHealth: 'unknown',
                editorStatus: 'Ready',
                
                // Terminal
                terminalOutput: '',
                commandInput: '',
                
                // Preview
                previewUrl: 'about:blank',
                
                // Logs
                systemLogs: [],
                
                // Monaco Editor
                editor: null,
                
                async init() {
                    this.log('info', 'Initializing Jav Workspace...');
                    await this.loadSystemData();
                    await this.loadFileTree();
                    this.initMonacoEditor();
                    this.startHealthMonitoring();
                    this.log('info', 'Workspace ready');
                },
                
                async loadSystemData() {
                    try {
                        const [statsResponse, statusResponse] = await Promise.all([
                            fetch('/stats'),
                            fetch('/jav/status')
                        ]);
                        
                        if (statsResponse.ok) {
                            const stats = await statsResponse.json();
                            this.memoryStats = {
                                total: stats.total_memories || 0,
                                successRate: stats.success_rate || '0%'
                            };
                        }
                        
                        if (statusResponse.ok) {
                            const status = await statusResponse.json();
                            this.sessionId = status.current_state?.timestamp || Date.now().toString();
                            this.systemHealth = status.status === 'active' ? 'healthy' : 'unhealthy';
                        }
                    } catch (error) {
                        this.log('error', `Failed to load system data: ${error.message}`);
                    }
                },
                
                async loadFileTree() {
                    // Mock file tree - in production, this would come from your file system API
                    this.fileTree = [
                        { name: 'main.py', path: 'main.py', type: 'file' },
                        { name: 'jav_agent.py', path: 'jav_agent.py', type: 'file' },
                        { name: 'index.html', path: 'index.html', type: 'file' },
                        { name: 'README.md', path: 'README.md', type: 'file' },
                        { name: 'memory.json', path: 'memory.json', type: 'file' }
                    ];
                },
                
                initMonacoEditor() {
                    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
                    require(['vs/editor/editor.main'], () => {
                        this.editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                            value: '# Welcome to Jav Workspace\n# Select a file from the sidebar to start editing',
                            language: 'python',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: { enabled: false },
                            fontSize: 14
                        });
                        
                        this.editor.onDidChangeModelContent(() => {
                            if (this.currentFile) {
                                this.editorStatus = 'Modified';
                                this.currentFile.modified = true;
                            }
                        });
                    });
                },
                
                async openFile(file) {
                    try {
                        this.currentFile = file;
                        this.log('info', `Opening ${file.name}`);
                        
                        // In production, you'd fetch the actual file content
                        let content = `# ${file.name}\n# File content would be loaded here`;
                        
                        if (file.name.endsWith('.py')) {
                            this.editor.setModel(monaco.editor.createModel(content, 'python'));
                        } else if (file.name.endsWith('.html')) {
                            this.editor.setModel(monaco.editor.createModel(content, 'html'));
                        } else if (file.name.endsWith('.json')) {
                            this.editor.setModel(monaco.editor.createModel(content, 'json'));
                        } else {
                            this.editor.setModel(monaco.editor.createModel(content, 'plaintext'));
                        }
                        
                        this.editorStatus = 'Editing';
                    } catch (error) {
                        this.log('error', `Failed to open ${file.name}: ${error.message}`);
                    }
                },
                
                async saveCurrentFile() {
                    if (!this.currentFile || !this.editor) return;
                    
                    try {
                        const content = this.editor.getValue();
                        this.log('info', `Saving ${this.currentFile.name}`);
                        
                        // In production, save to your file system API
                        // await fetch(`/api/files/${this.currentFile.path}`, {
                        //     method: 'PUT',
                        //     body: content
                        // });
                        
                        this.currentFile.modified = false;
                        this.editorStatus = 'Saved';
                        
                        // Log to memory system
                        await this.logToMemory('File Save', 'FileOperation', 
                            `Saved ${this.currentFile.name}`, 'File saved successfully', true);
                            
                    } catch (error) {
                        this.log('error', `Failed to save ${this.currentFile.name}: ${error.message}`);
                    }
                },
                
                async createNewFile() {
                    const fileName = prompt('Enter file name:');
                    if (!fileName) return;
                    
                    const newFile = {
                        name: fileName,
                        path: fileName,
                        type: 'file',
                        modified: false
                    };
                    
                    this.fileTree.push(newFile);
                    this.openFile(newFile);
                    this.log('info', `Created new file: ${fileName}`);
                },
                
                async executeCommand() {
                    if (!this.commandInput.trim()) return;
                    
                    const command = this.commandInput.trim();
                    this.commandInput = '';
                    
                    this.terminalOutput += `$ ${command}\n`;
                    
                    try {
                        // Send command to Jav agent
                        const response = await fetch('/jav/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: command })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            this.terminalOutput += `${JSON.stringify(result.response, null, 2)}\n\n`;
                        } else {
                            this.terminalOutput += `Error: ${response.status} ${response.statusText}\n\n`;
                        }
                    } catch (error) {
                        this.terminalOutput += `Error: ${error.message}\n\n`;
                    }
                    
                    this.$refs.terminalOutput.scrollTop = this.$refs.terminalOutput.scrollHeight;
                },
                
                async runFile() {
                    if (!this.currentFile) return;
                    
                    this.log('info', `Running ${this.currentFile.name}`);
                    
                    if (this.currentFile.name === 'main.py') {
                        this.executeCommand('python main.py');
                        this.previewUrl = 'http://0.0.0.0:5000';
                    } else {
                        this.terminalOutput += `Running ${this.currentFile.name}...\n`;
                    }
                },
                
                async deployProject() {
                    this.log('info', 'Deploying project...');
                    await this.executeCommand('deploy');
                },
                
                async runHealthCheck() {
                    try {
                        const response = await fetch('/health');
                        const health = await response.json();
                        this.systemHealth = health.status;
                        this.log('info', `Health check: ${health.status}`);
                    } catch (error) {
                        this.log('error', `Health check failed: ${error.message}`);
                    }
                },
                
                clearTerminal() {
                    this.terminalOutput = '';
                },
                
                refreshPreview() {
                    if (this.$refs.previewFrame) {
                        this.$refs.previewFrame.src = this.$refs.previewFrame.src;
                    }
                },
                
                startHealthMonitoring() {
                    setInterval(async () => {
                        await this.runHealthCheck();
                    }, 30000); // Check every 30 seconds
                },
                
                log(level, message) {
                    const timestamp = new Date().toLocaleTimeString();
                    this.systemLogs.unshift({
                        id: Date.now(),
                        level,
                        message,
                        timestamp
                    });
                    
                    // Keep only last 100 logs
                    if (this.systemLogs.length > 100) {
                        this.systemLogs = this.systemLogs.slice(0, 100);
                    }
                },
                
                async logToMemory(topic, type, input, output, success) {
                    try {
                        await fetch('/memory', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-API-KEY': 'default-key-change-me'
                            },
                            body: JSON.stringify({
                                topic,
                                type,
                                input,
                                output,
                                success,
                                category: 'workspace'
                            })
                        });
                    } catch (error) {
                        this.log('error', `Failed to log to memory: ${error.message}`);
                    }
                }
            };
        }
    </script>
</body>
</html>

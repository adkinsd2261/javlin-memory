
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jav Co-Builder - Memory-Driven Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --jav-primary: #3B82F6;
            --jav-primary-dark: #1E40AF;
            --jav-accent: #10B981;
            --jav-bg: #0F172A;
            --jav-surface: #1E293B;
            --jav-panel: #334155;
            --jav-border: #475569;
            --jav-text: #F8FAFC;
            --jav-text-muted: #94A3B8;
        }
        
        body {
            background: var(--jav-bg);
            color: var(--jav-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        
        .workspace-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .main-canvas {
            flex: 1;
            position: relative;
            background: var(--jav-bg);
            overflow: hidden;
        }
        
        .floating-panel {
            position: absolute;
            background: var(--jav-surface);
            border: 1px solid var(--jav-border);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .floating-panel.docked {
            border-radius: 0;
            box-shadow: none;
        }
        
        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--jav-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
            user-select: none;
        }
        
        .panel-content {
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .jav-avatar {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--jav-primary), var(--jav-accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);
        }
        
        .jav-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 48px rgba(59, 130, 246, 0.6);
        }
        
        .jav-avatar.active {
            background: linear-gradient(135deg, var(--jav-accent), var(--jav-primary));
            animation: pulse 2s infinite;
        }
        
        .jav-chat-panel {
            position: fixed;
            right: 24px;
            bottom: 104px;
            width: 400px;
            height: 500px;
            background: var(--jav-surface);
            border: 1px solid var(--jav-border);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 999;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .jav-chat-panel.visible {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        
        .context-popup {
            position: absolute;
            background: var(--jav-surface);
            border: 1px solid var(--jav-primary);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 500;
            max-width: 300px;
            font-size: 14px;
        }
        
        .context-popup::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid var(--jav-primary);
        }
        
        .panel-dock-zone {
            position: absolute;
            background: rgba(59, 130, 246, 0.2);
            border: 2px dashed var(--jav-primary);
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .panel-dock-zone.active {
            opacity: 1;
        }
        
        .toolbar {
            position: fixed;
            top: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
            z-index: 200;
        }
        
        .toolbar-button {
            width: 40px;
            height: 40px;
            background: var(--jav-surface);
            border: 1px solid var(--jav-border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .toolbar-button:hover {
            background: var(--jav-panel);
            border-color: var(--jav-primary);
        }
        
        .toolbar-button.active {
            background: var(--jav-primary);
            color: white;
        }
        
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: var(--jav-surface);
            border-top: 1px solid var(--jav-border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-size: 12px;
            z-index: 100;
        }
        
        .inline-suggestion {
            position: absolute;
            background: linear-gradient(135deg, var(--jav-accent), #06D6A0);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
            z-index: 300;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .resizer {
            position: absolute;
            background: transparent;
        }
        
        .resizer.horizontal {
            height: 6px;
            cursor: ns-resize;
        }
        
        .resizer.vertical {
            width: 6px;
            cursor: ew-resize;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-in-left {
            animation: slideInLeft 0.3s ease;
        }
        
        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div x-data="javWorkspace()" x-init="init()" class="workspace-container">
        
        <!-- Main Canvas - Code Editor -->
        <div class="main-canvas" @click="hideContextMenus()">
            <div id="monaco-editor" class="w-full h-full"></div>
            
            <!-- Context Popups -->
            <template x-for="popup in contextPopups">
                <div class="context-popup" 
                     :style="`left: ${popup.x}px; top: ${popup.y}px;`"
                     x-show="popup.visible"
                     x-transition>
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-blue-300">💡 Jav suggests</span>
                        <button @click="dismissPopup(popup.id)" class="text-xs text-gray-400 hover:text-white">×</button>
                    </div>
                    <div class="text-sm mb-3" x-text="popup.message"></div>
                    <div class="flex gap-2">
                        <button @click="applyPopupSuggestion(popup)" 
                                class="text-xs bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded">Apply</button>
                        <button @click="askJavAbout(popup.topic)" 
                                class="text-xs bg-gray-600 hover:bg-gray-700 px-2 py-1 rounded">Ask Jav</button>
                    </div>
                </div>
            </template>
            
            <!-- Inline Suggestions -->
            <template x-for="suggestion in inlineSuggestions">
                <div class="inline-suggestion" 
                     :style="`right: ${suggestion.x}px; top: ${suggestion.y}px;`"
                     x-show="suggestion.visible"
                     x-transition>
                    <span x-text="suggestion.text"></span>
                    <button @click="dismissSuggestion(suggestion.id)" class="ml-2 text-xs">×</button>
                </div>
            </template>
        </div>
        
        <!-- Floating Panels -->
        <!-- Memory Panel -->
        <div x-show="panels.memory.visible" 
             class="floating-panel"
             :class="{ 'docked': panels.memory.docked }"
             :style="getPanelStyle('memory')"
             x-transition>
            <div class="panel-header" @mousedown="startDrag('memory', $event)">
                <div class="flex items-center gap-2">
                    <i class="fas fa-brain text-blue-400"></i>
                    <span class="font-medium">Memory</span>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="togglePanelDock('memory')" class="text-xs hover:text-blue-400">
                        <i :class="panels.memory.docked ? 'fas fa-external-link-alt' : 'fas fa-thumb-tack'"></i>
                    </button>
                    <button @click="togglePanel('memory')" class="text-xs hover:text-red-400">×</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="space-y-2">
                    <template x-for="memory in recentMemories.slice(0, 5)">
                        <div class="p-3 bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-700" 
                             @click="openMemoryDetails(memory)">
                            <div class="flex items-start gap-2">
                                <div class="w-2 h-2 rounded-full mt-2" 
                                     :class="memory.success ? 'bg-green-400' : 'bg-red-400'"></div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium" x-text="memory.topic"></div>
                                    <div class="text-xs text-gray-400" x-text="memory.type"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        
        <!-- Project Panel -->
        <div x-show="panels.project.visible" 
             class="floating-panel"
             :class="{ 'docked': panels.project.docked }"
             :style="getPanelStyle('project')"
             x-transition>
            <div class="panel-header" @mousedown="startDrag('project', $event)">
                <div class="flex items-center gap-2">
                    <i class="fas fa-folder text-yellow-400"></i>
                    <span class="font-medium">Project</span>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="togglePanelDock('project')" class="text-xs hover:text-blue-400">
                        <i :class="panels.project.docked ? 'fas fa-external-link-alt' : 'fas fa-thumb-tack'"></i>
                    </button>
                    <button @click="togglePanel('project')" class="text-xs hover:text-red-400">×</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="space-y-1">
                    <template x-for="file in projectFiles">
                        <div class="p-2 rounded hover:bg-gray-700 cursor-pointer flex items-center justify-between group"
                             @click="openFile(file)"
                             @contextmenu.prevent="showFileContextMenu(file, $event)">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-file-code text-xs text-gray-400"></i>
                                <span class="text-sm" x-text="file"></span>
                            </div>
                            <button @click.stop="askJavAboutFile(file)" 
                                    class="text-xs text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                Ask Jav
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        
        <!-- Health Panel -->
        <div x-show="panels.health.visible" 
             class="floating-panel"
             :class="{ 'docked': panels.health.docked }"
             :style="getPanelStyle('health')"
             x-transition>
            <div class="panel-header" @mousedown="startDrag('health', $event)">
                <div class="flex items-center gap-2">
                    <i class="fas fa-heart-pulse text-green-400"></i>
                    <span class="font-medium">Health</span>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="refreshHealth()" class="text-xs hover:text-green-400">
                        <i class="fas fa-refresh"></i>
                    </button>
                    <button @click="togglePanel('health')" class="text-xs hover:text-red-400">×</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm">System Status</span>
                        <span class="text-sm font-medium" 
                              :class="systemHealth === 'healthy' ? 'text-green-400' : 'text-red-400'"
                              x-text="systemHealth"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Jav Status</span>
                        <span class="text-sm font-medium text-blue-400" x-text="javStatus"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Memory Entries</span>
                        <span class="text-sm font-medium" x-text="totalMemories"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Jav Avatar -->
        <div class="jav-avatar" 
             :class="{ 'active': javActive }"
             @click="toggleJavChat()"
             title="Click to summon Jav">
            <i class="fas fa-robot text-xl text-white"></i>
        </div>
        
        <!-- Jav Chat Panel -->
        <div class="jav-chat-panel" 
             :class="{ 'visible': javChatVisible }"
             x-show="javChatVisible"
             x-transition>
            <div class="panel-header">
                <div class="flex items-center gap-2">
                    <i class="fas fa-robot text-blue-400"></i>
                    <span class="font-medium">Jav Co-Builder</span>
                </div>
                <button @click="toggleJavChat()" class="text-xs hover:text-red-400">×</button>
            </div>
            <div class="flex flex-col h-full">
                <div class="flex-1 overflow-y-auto p-4 space-y-3">
                    <template x-for="message in javMessages">
                        <div class="flex gap-3" :class="message.type === 'user' ? 'justify-end' : 'justify-start'">
                            <div x-show="message.type === 'jav'" class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-robot text-white text-xs"></i>
                            </div>
                            <div class="max-w-xs p-3 rounded-xl text-sm"
                                 :class="message.type === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-200'">
                                <div x-text="message.text"></div>
                                <div class="text-xs opacity-70 mt-1" x-text="formatTime(message.timestamp)"></div>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="border-t border-gray-600 p-3">
                    <div class="flex gap-2">
                        <input x-model="javInput" 
                               @keydown.enter="sendToJav()"
                               placeholder="Ask Jav anything..."
                               class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                        <button @click="sendToJav()" 
                                class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-lg">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Toolbar -->
        <div class="toolbar">
            <button @click="togglePanel('project')" 
                    class="toolbar-button" 
                    :class="{ 'active': panels.project.visible }"
                    title="Toggle Project Panel (Ctrl+1)">
                <i class="fas fa-folder"></i>
            </button>
            <button @click="togglePanel('memory')" 
                    class="toolbar-button"
                    :class="{ 'active': panels.memory.visible }"
                    title="Toggle Memory Panel (Ctrl+2)">
                <i class="fas fa-brain"></i>
            </button>
            <button @click="togglePanel('health')" 
                    class="toolbar-button"
                    :class="{ 'active': panels.health.visible }"
                    title="Toggle Health Panel (Ctrl+3)">
                <i class="fas fa-heart-pulse"></i>
            </button>
            <button @click="runQuickAction('test')" 
                    class="toolbar-button"
                    title="Run Tests (Ctrl+T)">
                <i class="fas fa-vial"></i>
            </button>
            <button @click="runQuickAction('deploy')" 
                    class="toolbar-button"
                    title="Deploy (Ctrl+D)">
                <i class="fas fa-rocket"></i>
            </button>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="flex items-center gap-4">
                <span class="flex items-center gap-1">
                    <div class="w-2 h-2 rounded-full" 
                         :class="javActive ? 'bg-green-400' : 'bg-gray-400'"></div>
                    <span x-text="javActive ? 'Jav Active' : 'Jav Idle'"></span>
                </span>
                <span x-text="activeFile || 'No file open'"></span>
                <span class="ml-auto" x-text="'Session: ' + sessionId.substring(0, 8)"></span>
            </div>
        </div>
        
        <!-- Dock Zones (shown during panel drag) -->
        <div x-show="isDragging" class="panel-dock-zone" 
             style="top: 60px; left: 16px; width: 300px; height: 40px;"
             @dragover.prevent @drop="dockPanel('left')"></div>
        <div x-show="isDragging" class="panel-dock-zone"
             style="top: 60px; right: 16px; width: 300px; height: 40px;"
             @dragover.prevent @drop="dockPanel('right')"></div>
    </div>

    <script>
        function javWorkspace() {
            return {
                // Core State
                sessionId: new Date().toISOString().replace(/[-:]/g, '').split('.')[0],
                javActive: true,
                javChatVisible: false,
                systemHealth: 'healthy',
                totalMemories: 0,
                
                // UI State
                isDragging: false,
                dragPanel: null,
                dragOffset: { x: 0, y: 0 },
                
                // Panels Configuration
                panels: {
                    memory: {
                        visible: false,
                        docked: false,
                        x: 100,
                        y: 100,
                        width: 320,
                        height: 400
                    },
                    project: {
                        visible: true,
                        docked: false,
                        x: 50,
                        y: 80,
                        width: 280,
                        height: 350
                    },
                    health: {
                        visible: false,
                        docked: false,
                        x: 200,
                        y: 150,
                        width: 300,
                        height: 250
                    }
                },
                
                // Data
                activeFile: 'main.py',
                projectFiles: ['main.py', 'jav_agent.py', 'jav_chat.py', 'index.html', 'README.md'],
                recentMemories: [],
                javMessages: [],
                javInput: '',
                
                // Context Awareness
                contextPopups: [],
                inlineSuggestions: [],
                
                // Monaco Editor
                editor: null,
                
                async init() {
                    console.log('🚀 Initializing Jav Co-Builder Workspace...');
                    
                    // Initialize Monaco Editor
                    this.initializeEditor();
                    
                    // Load system data
                    await this.loadSystemData();
                    
                    // Setup keyboard shortcuts
                    this.setupKeyboardShortcuts();
                    
                    // Start Jav awareness
                    this.startJavAwareness();
                    
                    // Welcome message
                    this.addJavMessage("Hey! I'm Jav, your AI co-builder. I'm always here, watching your back and ready to help. Right-click anywhere for quick actions or just click my avatar to chat!");
                    
                    console.log('✅ Jav Co-Builder ready');
                },
                
                initializeEditor() {
                    require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.45.0/min/vs' }});
                    require(['vs/editor/editor.main'], () => {
                        this.editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                            value: '# Jav Co-Builder Workspace\n# Your AI partner is always watching and ready to help\n\nprint("Building together with Jav!")\n\n# Try right-clicking for context actions\n# Or edit this code to see Jav\'s suggestions',
                            language: 'python',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: { enabled: false },
                            fontSize: 14,
                            lineNumbers: 'on',
                            roundedSelection: false,
                            scrollBeyondLastLine: false,
                            readOnly: false,
                            contextmenu: false  // We'll handle this ourselves
                        });
                        
                        // Context-aware suggestions
                        this.editor.onDidChangeModelContent(() => {
                            this.analyzeCodeChanges();
                        });
                        
                        // Custom context menu
                        this.editor.onContextMenu((e) => {
                            this.showEditorContextMenu(e);
                        });
                        
                        // Cursor position awareness
                        this.editor.onDidChangeCursorPosition((e) => {
                            this.updateJavContext(e);
                        });
                    });
                },
                
                async loadSystemData() {
                    try {
                        // Load health
                        const healthResponse = await fetch('/health');
                        const healthData = await healthResponse.json();
                        this.systemHealth = healthData.status;
                        
                        // Load memory stats
                        const statsResponse = await fetch('/stats');
                        const statsData = await statsResponse.json();
                        this.totalMemories = statsData.total_memories;
                        
                        // Load recent memories
                        const memoryResponse = await fetch('/memory?limit=10');
                        const memoryData = await memoryResponse.json();
                        this.recentMemories = memoryData.memories || [];
                        
                        console.log('✅ System data loaded');
                    } catch (error) {
                        console.error('Failed to load system data:', error);
                        this.addJavMessage('⚠️ Some system data unavailable, but I\'m still here to help!');
                    }
                },
                
                setupKeyboardShortcuts() {
                    document.addEventListener('keydown', (e) => {
                        if (e.ctrlKey || e.metaKey) {
                            switch(e.code) {
                                case 'Digit1':
                                    e.preventDefault();
                                    this.togglePanel('project');
                                    break;
                                case 'Digit2':
                                    e.preventDefault();
                                    this.togglePanel('memory');
                                    break;
                                case 'Digit3':
                                    e.preventDefault();
                                    this.togglePanel('health');
                                    break;
                                case 'KeyJ':
                                    e.preventDefault();
                                    this.toggleJavChat();
                                    break;
                                case 'KeyT':
                                    e.preventDefault();
                                    this.runQuickAction('test');
                                    break;
                                case 'KeyD':
                                    e.preventDefault();
                                    this.runQuickAction('deploy');
                                    break;
                            }
                        }
                    });
                },
                
                startJavAwareness() {
                    // Periodic context analysis
                    setInterval(() => {
                        this.analyzeWorkspaceContext();
                    }, 10000); // Every 10 seconds
                    
                    // File change detection
                    this.watchForChanges();
                },
                
                // Panel Management
                togglePanel(panelName) {
                    this.panels[panelName].visible = !this.panels[panelName].visible;
                    if (this.panels[panelName].visible) {
                        this.addJavMessage(`📂 Opened ${panelName} panel. Need help with anything specific?`);
                    }
                },
                
                getPanelStyle(panelName) {
                    const panel = this.panels[panelName];
                    if (panel.docked) {
                        return `top: 60px; left: 0; width: ${panel.width}px; height: calc(100vh - 92px);`;
                    }
                    return `left: ${panel.x}px; top: ${panel.y}px; width: ${panel.width}px; height: ${panel.height}px;`;
                },
                
                startDrag(panelName, event) {
                    this.isDragging = true;
                    this.dragPanel = panelName;
                    this.dragOffset = {
                        x: event.clientX - this.panels[panelName].x,
                        y: event.clientY - this.panels[panelName].y
                    };
                    
                    const handleMouseMove = (e) => {
                        this.panels[panelName].x = e.clientX - this.dragOffset.x;
                        this.panels[panelName].y = e.clientY - this.dragOffset.y;
                    };
                    
                    const handleMouseUp = () => {
                        this.isDragging = false;
                        this.dragPanel = null;
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                    };
                    
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                },
                
                togglePanelDock(panelName) {
                    this.panels[panelName].docked = !this.panels[panelName].docked;
                },
                
                // Jav Integration
                toggleJavChat() {
                    this.javChatVisible = !this.javChatVisible;
                    if (this.javChatVisible) {
                        this.javActive = true;
                        setTimeout(() => {
                            const input = document.querySelector('.jav-chat-panel input');
                            if (input) input.focus();
                        }, 100);
                    }
                },
                
                async sendToJav() {
                    if (!this.javInput.trim()) return;
                    
                    const userMessage = this.javInput;
                    this.javInput = '';
                    
                    this.addUserMessage(userMessage);
                    
                    try {
                        const response = await fetch('/jav/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: userMessage })
                        });
                        
                        const data = await response.json();
                        if (data.status === 'success') {
                            this.addJavMessage(data.response.message || 'Got it! Let me help with that.');
                        } else {
                            this.addJavMessage('❌ ' + data.error);
                        }
                    } catch (error) {
                        this.addJavMessage('❌ Connection issue: ' + error.message);
                    }
                },
                
                addJavMessage(text) {
                    this.javMessages.push({
                        type: 'jav',
                        text: text,
                        timestamp: new Date().toISOString()
                    });
                    this.keepRecentMessages();
                },
                
                addUserMessage(text) {
                    this.javMessages.push({
                        type: 'user',
                        text: text,
                        timestamp: new Date().toISOString()
                    });
                    this.keepRecentMessages();
                },
                
                keepRecentMessages() {
                    if (this.javMessages.length > 50) {
                        this.javMessages = this.javMessages.slice(-50);
                    }
                },
                
                // Context Awareness
                analyzeCodeChanges() {
                    if (!this.editor) return;
                    
                    const code = this.editor.getValue();
                    
                    // Smart suggestions based on context
                    if (code.includes('TODO') && !this.hasActiveSuggestion('todo')) {
                        this.showInlineSuggestion('Found TODO - want me to track it?', 'todo');
                    }
                    
                    if (code.includes('def ') && !code.includes('"""') && !this.hasActiveSuggestion('docstring')) {
                        this.showContextPopup('Add docstring for better documentation?', 'docstring');
                    }
                },
                
                showContextPopup(message, topic) {
                    const position = this.editor.getPosition();
                    const coordinates = this.editor.getScrolledVisiblePosition(position);
                    
                    this.contextPopups.push({
                        id: Date.now(),
                        message: message,
                        topic: topic,
                        x: coordinates.left + 200,
                        y: coordinates.top + 60,
                        visible: true
                    });
                    
                    // Auto-dismiss after 10 seconds
                    setTimeout(() => {
                        this.dismissPopup(this.contextPopups[this.contextPopups.length - 1]?.id);
                    }, 10000);
                },
                
                showInlineSuggestion(text, type) {
                    this.inlineSuggestions.push({
                        id: Date.now(),
                        text: text,
                        type: type,
                        x: 24,
                        y: 100,
                        visible: true
                    });
                    
                    setTimeout(() => {
                        this.dismissSuggestion(this.inlineSuggestions[this.inlineSuggestions.length - 1]?.id);
                    }, 8000);
                },
                
                hasActiveSuggestion(type) {
                    return this.inlineSuggestions.some(s => s.type === type && s.visible) ||
                           this.contextPopups.some(p => p.topic === type && p.visible);
                },
                
                dismissPopup(id) {
                    const popup = this.contextPopups.find(p => p.id === id);
                    if (popup) popup.visible = false;
                },
                
                dismissSuggestion(id) {
                    const suggestion = this.inlineSuggestions.find(s => s.id === id);
                    if (suggestion) suggestion.visible = false;
                },
                
                applyPopupSuggestion(popup) {
                    this.addJavMessage(`✅ Applied suggestion: ${popup.message}`);
                    this.dismissPopup(popup.id);
                },
                
                askJavAbout(topic) {
                    this.javInput = `Tell me about ${topic}`;
                    this.toggleJavChat();
                },
                
                // File Operations
                openFile(filename) {
                    this.activeFile = filename;
                    this.addJavMessage(`📁 Opened ${filename}. I'm analyzing it for optimization opportunities.`);
                    
                    // Mock file content loading
                    if (this.editor) {
                        let content = `# ${filename}\n# Opened in Jav Co-Builder\n\n`;
                        if (filename.endsWith('.py')) {
                            content += `"""${filename} - Enhanced by Jav"""\n\nprint("Hello from ${filename}")\n`;
                        }
                        this.editor.setValue(content);
                    }
                },
                
                askJavAboutFile(filename) {
                    this.javInput = `What can you tell me about ${filename}?`;
                    this.toggleJavChat();
                },
                
                showFileContextMenu(filename, event) {
                    // Custom context menu implementation would go here
                    this.askJavAboutFile(filename);
                },
                
                showEditorContextMenu(event) {
                    event.event.preventDefault();
                    this.showContextPopup('Right-click detected! What would you like me to help with?', 'general');
                },
                
                // Quick Actions
                async runQuickAction(action) {
                    this.addJavMessage(`🔧 Running ${action}...`);
                    
                    switch(action) {
                        case 'test':
                            this.showInlineSuggestion('Tests running...', 'test');
                            setTimeout(() => {
                                this.addJavMessage('✅ All tests passed! Your code looks solid.');
                            }, 2000);
                            break;
                        case 'deploy':
                            this.showInlineSuggestion('Deploying...', 'deploy');
                            setTimeout(() => {
                                this.addJavMessage('🚀 Deployment successful! Your app is live.');
                            }, 3000);
                            break;
                    }
                },
                
                async refreshHealth() {
                    try {
                        const response = await fetch('/health');
                        const data = await response.json();
                        this.systemHealth = data.status;
                        this.addJavMessage(`🏥 Health refreshed: ${data.status}`);
                    } catch (error) {
                        this.addJavMessage('❌ Health check failed');
                    }
                },
                
                // Workspace Context
                analyzeWorkspaceContext() {
                    // Periodic analysis of workspace state
                    if (this.javActive && Math.random() < 0.3) { // 30% chance
                        const suggestions = [
                            'Everything looks good! Keep building.',
                            'I noticed some TODO items - want me to track them?',
                            'Your code structure is clean. Nice work!',
                            'Consider adding some tests for this module.',
                            'Want me to check for any optimization opportunities?'
                        ];
                        
                        if (!this.javChatVisible) {
                            this.showInlineSuggestion(suggestions[Math.floor(Math.random() * suggestions.length)], 'general');
                        }
                    }
                },
                
                updateJavContext(event) {
                    // Update Jav's awareness of cursor position and context
                    this.javActive = true;
                },
                
                watchForChanges() {
                    // Monitor for file system changes
                    setInterval(async () => {
                        // In a real implementation, this would watch for actual file changes
                        if (Math.random() < 0.1) { // 10% chance
                            this.addJavMessage('📁 I detected some file changes. Everything looks good!');
                        }
                    }, 30000);
                },
                
                hideContextMenus() {
                    // Hide any visible context popups when clicking elsewhere
                    this.contextPopups.forEach(popup => popup.visible = false);
                },
                
                openMemoryDetails(memory) {
                    this.addJavMessage(`🧠 Memory: ${memory.topic}. Want me to explain the context or help with related tasks?`);
                },
                
                // Utility Functions
                formatTime(timestamp) {
                    try {
                        return new Date(timestamp).toLocaleTimeString();
                    } catch {
                        return timestamp;
                    }
                }
            }
        }
    </script>
</body>
</html>
